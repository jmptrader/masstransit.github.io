<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Autofac | MassTransit</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#3a0839">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="description" content="A free, open-source distributed application framework for .NET.">
    <meta name="msapplication-TileColor" content="#3a0839">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.75c9abf4.css" as="style"><link rel="preload" href="/assets/js/app.195ff7db.js" as="script"><link rel="preload" href="/assets/js/3.49f501da.js" as="script"><link rel="preload" href="/assets/js/108.6d56d230.js" as="script"><link rel="prefetch" href="/assets/js/10.a0cd44ab.js"><link rel="prefetch" href="/assets/js/100.9feb174f.js"><link rel="prefetch" href="/assets/js/101.f3afae1f.js"><link rel="prefetch" href="/assets/js/102.edc3cfd3.js"><link rel="prefetch" href="/assets/js/103.396b5261.js"><link rel="prefetch" href="/assets/js/104.35ef931e.js"><link rel="prefetch" href="/assets/js/105.75295f36.js"><link rel="prefetch" href="/assets/js/106.c42d7948.js"><link rel="prefetch" href="/assets/js/107.4cddb7d4.js"><link rel="prefetch" href="/assets/js/109.3a2c9c0e.js"><link rel="prefetch" href="/assets/js/11.3d40bd0b.js"><link rel="prefetch" href="/assets/js/110.c4aa15ea.js"><link rel="prefetch" href="/assets/js/111.c661ab49.js"><link rel="prefetch" href="/assets/js/112.0f444d04.js"><link rel="prefetch" href="/assets/js/113.b7745232.js"><link rel="prefetch" href="/assets/js/114.1f4ecadb.js"><link rel="prefetch" href="/assets/js/115.6acc0049.js"><link rel="prefetch" href="/assets/js/116.59b4c1e7.js"><link rel="prefetch" href="/assets/js/117.0089265d.js"><link rel="prefetch" href="/assets/js/118.dee3db3a.js"><link rel="prefetch" href="/assets/js/119.c2dd72f1.js"><link rel="prefetch" href="/assets/js/12.67901ed9.js"><link rel="prefetch" href="/assets/js/120.2f521996.js"><link rel="prefetch" href="/assets/js/121.bf5544df.js"><link rel="prefetch" href="/assets/js/122.f63abbe1.js"><link rel="prefetch" href="/assets/js/123.d34457fe.js"><link rel="prefetch" href="/assets/js/124.39757413.js"><link rel="prefetch" href="/assets/js/125.5ae9566e.js"><link rel="prefetch" href="/assets/js/126.73bcf6ec.js"><link rel="prefetch" href="/assets/js/127.3d4534d5.js"><link rel="prefetch" href="/assets/js/128.c47aea17.js"><link rel="prefetch" href="/assets/js/129.e6499def.js"><link rel="prefetch" href="/assets/js/13.773b7e4f.js"><link rel="prefetch" href="/assets/js/130.30e02611.js"><link rel="prefetch" href="/assets/js/131.371a8da4.js"><link rel="prefetch" href="/assets/js/132.f5ff377c.js"><link rel="prefetch" href="/assets/js/133.edee58ae.js"><link rel="prefetch" href="/assets/js/134.40abac7e.js"><link rel="prefetch" href="/assets/js/135.7b10e613.js"><link rel="prefetch" href="/assets/js/136.6c4a4c9e.js"><link rel="prefetch" href="/assets/js/137.898fd9a1.js"><link rel="prefetch" href="/assets/js/138.c6591b9d.js"><link rel="prefetch" href="/assets/js/139.27a7976e.js"><link rel="prefetch" href="/assets/js/14.162fd7de.js"><link rel="prefetch" href="/assets/js/140.8f5fbf89.js"><link rel="prefetch" href="/assets/js/141.d2c4074e.js"><link rel="prefetch" href="/assets/js/142.ca465ae2.js"><link rel="prefetch" href="/assets/js/143.74deca00.js"><link rel="prefetch" href="/assets/js/144.70d74a91.js"><link rel="prefetch" href="/assets/js/145.6b2b56f8.js"><link rel="prefetch" href="/assets/js/146.f192058f.js"><link rel="prefetch" href="/assets/js/147.2dd1eca6.js"><link rel="prefetch" href="/assets/js/148.63cb766b.js"><link rel="prefetch" href="/assets/js/149.ecc8a933.js"><link rel="prefetch" href="/assets/js/15.5698f0da.js"><link rel="prefetch" href="/assets/js/150.4b4c3db8.js"><link rel="prefetch" href="/assets/js/16.5359a736.js"><link rel="prefetch" href="/assets/js/17.e09dee46.js"><link rel="prefetch" href="/assets/js/18.89fe105c.js"><link rel="prefetch" href="/assets/js/19.0ba8fb0f.js"><link rel="prefetch" href="/assets/js/20.a337dd2d.js"><link rel="prefetch" href="/assets/js/21.93618127.js"><link rel="prefetch" href="/assets/js/22.2956ed34.js"><link rel="prefetch" href="/assets/js/23.e7e073ac.js"><link rel="prefetch" href="/assets/js/24.6ae343c9.js"><link rel="prefetch" href="/assets/js/25.e5d4db2a.js"><link rel="prefetch" href="/assets/js/26.49ddf5e0.js"><link rel="prefetch" href="/assets/js/27.8ea45a54.js"><link rel="prefetch" href="/assets/js/28.ccb2b926.js"><link rel="prefetch" href="/assets/js/29.2433cbcd.js"><link rel="prefetch" href="/assets/js/30.b11f80e9.js"><link rel="prefetch" href="/assets/js/31.81256fb7.js"><link rel="prefetch" href="/assets/js/32.2ff0c303.js"><link rel="prefetch" href="/assets/js/33.4ce9ddd1.js"><link rel="prefetch" href="/assets/js/34.03bffcee.js"><link rel="prefetch" href="/assets/js/35.f8a9a551.js"><link rel="prefetch" href="/assets/js/36.8520137a.js"><link rel="prefetch" href="/assets/js/37.d9c6f0fa.js"><link rel="prefetch" href="/assets/js/38.92b36679.js"><link rel="prefetch" href="/assets/js/39.b958e128.js"><link rel="prefetch" href="/assets/js/4.c4d02356.js"><link rel="prefetch" href="/assets/js/40.29108793.js"><link rel="prefetch" href="/assets/js/41.a6366543.js"><link rel="prefetch" href="/assets/js/42.8b148511.js"><link rel="prefetch" href="/assets/js/43.e1763fb1.js"><link rel="prefetch" href="/assets/js/44.88d180c5.js"><link rel="prefetch" href="/assets/js/45.14b10a7d.js"><link rel="prefetch" href="/assets/js/46.93e3c7d7.js"><link rel="prefetch" href="/assets/js/47.e048c8cd.js"><link rel="prefetch" href="/assets/js/48.c5f9b4e8.js"><link rel="prefetch" href="/assets/js/49.70bccd74.js"><link rel="prefetch" href="/assets/js/5.4e88fd54.js"><link rel="prefetch" href="/assets/js/50.73312e50.js"><link rel="prefetch" href="/assets/js/51.e3a23273.js"><link rel="prefetch" href="/assets/js/52.ac5850db.js"><link rel="prefetch" href="/assets/js/53.964975e2.js"><link rel="prefetch" href="/assets/js/54.f8d8e32f.js"><link rel="prefetch" href="/assets/js/55.adab5810.js"><link rel="prefetch" href="/assets/js/56.aa0168c6.js"><link rel="prefetch" href="/assets/js/57.74697c72.js"><link rel="prefetch" href="/assets/js/58.0e7e958f.js"><link rel="prefetch" href="/assets/js/59.ee99df0c.js"><link rel="prefetch" href="/assets/js/6.b8b20bba.js"><link rel="prefetch" href="/assets/js/60.c20c903c.js"><link rel="prefetch" href="/assets/js/61.74ebb11f.js"><link rel="prefetch" href="/assets/js/62.5d7a7e72.js"><link rel="prefetch" href="/assets/js/63.c62b52d3.js"><link rel="prefetch" href="/assets/js/64.7c77fdd3.js"><link rel="prefetch" href="/assets/js/65.cb59ccfd.js"><link rel="prefetch" href="/assets/js/66.a7c3f8b7.js"><link rel="prefetch" href="/assets/js/67.95703483.js"><link rel="prefetch" href="/assets/js/68.6b4aef53.js"><link rel="prefetch" href="/assets/js/69.d94ed977.js"><link rel="prefetch" href="/assets/js/7.03c52a18.js"><link rel="prefetch" href="/assets/js/70.30b89105.js"><link rel="prefetch" href="/assets/js/71.7fb0a32a.js"><link rel="prefetch" href="/assets/js/72.04d95023.js"><link rel="prefetch" href="/assets/js/73.2ff7a268.js"><link rel="prefetch" href="/assets/js/74.d5c20b17.js"><link rel="prefetch" href="/assets/js/75.93bb57ce.js"><link rel="prefetch" href="/assets/js/76.55eb3fc8.js"><link rel="prefetch" href="/assets/js/77.5f66661c.js"><link rel="prefetch" href="/assets/js/78.14d0f57b.js"><link rel="prefetch" href="/assets/js/79.669c7d06.js"><link rel="prefetch" href="/assets/js/8.a356396f.js"><link rel="prefetch" href="/assets/js/80.efcf2688.js"><link rel="prefetch" href="/assets/js/81.d2e10130.js"><link rel="prefetch" href="/assets/js/82.b8ec9c21.js"><link rel="prefetch" href="/assets/js/83.9f22d6f2.js"><link rel="prefetch" href="/assets/js/84.4d1a6f69.js"><link rel="prefetch" href="/assets/js/85.d0dbb86b.js"><link rel="prefetch" href="/assets/js/86.3aa72ece.js"><link rel="prefetch" href="/assets/js/87.54f22267.js"><link rel="prefetch" href="/assets/js/88.85b21d95.js"><link rel="prefetch" href="/assets/js/89.2e8b9c83.js"><link rel="prefetch" href="/assets/js/9.ab3eeae2.js"><link rel="prefetch" href="/assets/js/90.61a4bb62.js"><link rel="prefetch" href="/assets/js/91.fef73b59.js"><link rel="prefetch" href="/assets/js/92.aec6eac0.js"><link rel="prefetch" href="/assets/js/93.caab4000.js"><link rel="prefetch" href="/assets/js/94.a156da91.js"><link rel="prefetch" href="/assets/js/95.a8412a27.js"><link rel="prefetch" href="/assets/js/96.d38de525.js"><link rel="prefetch" href="/assets/js/97.ede060e4.js"><link rel="prefetch" href="/assets/js/98.40ba68d7.js"><link rel="prefetch" href="/assets/js/99.fd9d661c.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.21f21cd2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.75c9abf4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/mt-logo-small.png" alt="MassTransit" class="logo"> <span class="site-name can-hide">MassTransit</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/getting-started/live-coding.html" class="sidebar-link">Live Coding</a></li><li><a href="/getting-started/upgrade-v6.html" class="sidebar-link">Upgrading</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/releases/" class="sidebar-heading clickable"><span>Release Notes</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/usage/" class="sidebar-heading clickable router-link-active open"><span>Using MassTransit</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/usage/configuration.html" class="sidebar-link">Configuration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/transports/" class="sidebar-heading clickable"><span>Transports</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/riders/" class="sidebar-heading clickable"><span>Riders</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/mediator.html" class="sidebar-link">Mediator</a></li><li><a href="/usage/messages.html" class="sidebar-link">Messages</a></li><li><a href="/usage/consumers.html" class="sidebar-link">Consumers</a></li><li><a href="/usage/producers.html" class="sidebar-link">Producers</a></li><li><a href="/usage/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/usage/requests.html" class="sidebar-link">Requests</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/sagas/" class="sidebar-heading clickable"><span>Sagas</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/containers/" class="sidebar-heading clickable router-link-active open"><span>Containers</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/usage/containers/definitions.html" class="sidebar-link">Definitions</a></li><li><a href="/usage/containers/msdi.html" class="sidebar-link">Microsoft</a></li><li><a href="/usage/containers/multibus.html" class="sidebar-link">MultiBus</a></li><li><a href="/usage/containers/autofac.html" aria-current="page" class="active sidebar-link">Autofac</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/usage/containers/autofac.html#using-nested-container" class="sidebar-link">Using Nested Container</a></li><li class="sidebar-sub-header"><a href="/usage/containers/autofac.html#using-a-module" class="sidebar-link">Using a Module</a></li><li class="sidebar-sub-header"><a href="/usage/containers/autofac.html#registering-state-machine-sagas" class="sidebar-link">Registering State Machine Sagas</a></li><li class="sidebar-sub-header"><a href="/usage/containers/autofac.html#saga-persistence" class="sidebar-link">Saga persistence</a></li></ul></li><li><a href="/usage/containers/castlewindsor.html" class="sidebar-link">Castle Windsor</a></li><li><a href="/usage/containers/simpleinjector.html" class="sidebar-link">Simple Injector</a></li><li><a href="/usage/containers/structuremap.html" class="sidebar-link">StructureMap</a></li></ul></section></li><li><a href="/usage/testing.html" class="sidebar-link">Testing</a></li><li><a href="/usage/logging.html" class="sidebar-link">Logging</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Advanced</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/learn/" class="sidebar-heading clickable"><span>Getting Help</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Articles</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/platform/" class="sidebar-heading clickable"><span>Platform</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="autofac"><a href="#autofac" class="header-anchor">#</a> Autofac</h1> <p>Autofac is a powerful and fast container, and is well supported by MassTransit. Nested lifetime scopes are used extensively to encapsulate dependencies and ensure clean object lifetime management. The following examples show the various ways that MassTransit can be configured, including the appropriate interfaces necessary.</p> <p>A sample project for the container registration code is available on <a href="https://github.com/MassTransit/Sample-Containers" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <blockquote><p>Requires NuGets <code>MassTransit</code>, <code>MassTransit.AutoFac</code>, and <code>MassTransit.RabbitMQ</code></p></blockquote> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Consumers should not depend upon <i>IBus</i> or <i>IBusControl</i>. A consumer should use the <i>ConsumeContext</i> instead, which has all of the same methods as <i>IBus</i>, but is scoped to the receive endpoint. This ensures that messages can be tracked between consumers and are sent from the proper address.</p></div> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Autofac</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">MassTransit</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Example</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UpdateCustomerAddressConsumer</span> <span class="token punctuation">:</span> 
        <span class="token type-list"><span class="token class-name">MassTransit<span class="token punctuation">.</span>IConsumer<span class="token punctuation">&lt;</span>UpdateCustomerAddress<span class="token punctuation">&gt;</span></span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Consume</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext<span class="token punctuation">&lt;</span>UpdateCustomerAddress<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//do stuff</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ContainerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// add a specific consumer</span>
                x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UpdateCustomerAddressConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// add all consumers in the specified assembly</span>
                x<span class="token punctuation">.</span><span class="token function">AddConsumers</span><span class="token punctuation">(</span>Assembly<span class="token punctuation">.</span><span class="token function">GetExecutingAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// add consumers by type</span>
                x<span class="token punctuation">.</span><span class="token function">AddConsumers</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ConsumerOne</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ConsumerTwo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// add the bus to the container</span>
                x<span class="token punctuation">.</span><span class="token function">UsingRabbitMq</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;customer_update&quot;</span><span class="token punctuation">,</span> ec <span class="token operator">=&gt;</span>
                    <span class="token punctuation">{</span>
                        <span class="token comment">// Configure a single consumer</span>
                        ec<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConfigureConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UpdateCustomerConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// configure all consumers</span>
                        ec<span class="token punctuation">.</span><span class="token function">ConfigureConsumers</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// configure consumer by type</span>
                        ec<span class="token punctuation">.</span><span class="token function">ConfigureConsumer</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ConsumerOne</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// or, configure the endpoints by convention</span>
                    cfg<span class="token punctuation">.</span><span class="token function">ConfigureEndpoints</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> container <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> bc <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBusControl<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bc<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="using-nested-container"><a href="#using-nested-container" class="header-anchor">#</a> Using Nested Container</h2> <p>MassTransit and Autofac give you an ability to reconfigure your container based on Consumer. It could be very powerful when you have different way to resolve your services depends on Consumer's type. It could be very helpful to build Multitenant applications.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterType</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>HttpTenantProvider<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ITenantProvider<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

builder<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> busControl <span class="token operator">=</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//configuration</span>
        cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> ec <span class="token operator">=&gt;</span> 
        <span class="token punctuation">{</span>
            ec<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Consumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>YourConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">&quot;scope_name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>c<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                c<span class="token punctuation">.</span><span class="token function">RegisterInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConsumerTenantProvider</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ITenantProvider<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//other configuration</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="using-a-module"><a href="#using-a-module" class="header-anchor">#</a> Using a Module</h2> <p>Autofac modules are great for encapsulating configuration, and that is equally true when using MassTransit. An example of using modules with Autofac is shown below.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">class</span> <span class="token class-name">ConsumerModule</span> <span class="token punctuation">:</span> 
<span class="token type-list"><span class="token class-name">Module</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Load</span><span class="token punctuation">(</span><span class="token class-name">ContainerBuilder</span> builder<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// requires that AddMassTransit has been called prior to this </span>
        <span class="token comment">// module being loaded, maybe, I don't know for sure that this</span>
        <span class="token comment">// is even possible</span>
        builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddConsumer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UpdateCustomerAddressConsumer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterType</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SqlCustomerRegistry<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ICustomerRegistry<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">BusModule</span> <span class="token punctuation">:</span> 
    <span class="token type-list"><span class="token class-name">Module</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Load</span><span class="token punctuation">(</span><span class="token class-name">ContainerBuilder</span> builder<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> busSettings <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>BusSettings<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> busControl <span class="token operator">=</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span>busSettings<span class="token punctuation">.</span>HostAddress<span class="token punctuation">,</span> h <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    h<span class="token punctuation">.</span><span class="token function">Username</span><span class="token punctuation">(</span>busSettings<span class="token punctuation">.</span>Username<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    h<span class="token punctuation">.</span><span class="token function">Password</span><span class="token punctuation">(</span>busSettings<span class="token punctuation">.</span>Password<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                cfg<span class="token punctuation">.</span><span class="token function">AddConsumersFromContainer</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

                cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span>busSettings<span class="token punctuation">.</span>QueueName<span class="token punctuation">,</span> ec <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    ec<span class="token punctuation">.</span><span class="token function">ConfigureConsumers</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">SingleInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBusControl<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBus<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token return-type class-name">IContainer</span> <span class="token function">CreateContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ContainerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterModule</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>BusModule<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterModule</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ConsumerModule<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="registering-state-machine-sagas"><a href="#registering-state-machine-sagas" class="header-anchor">#</a> Registering State Machine Sagas</h2> <p>You can also register state machine sagas:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ContainerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// register everything else</span>

<span class="token comment">// register saga state machines, assuming Saga1 and Saga2 are in different assemblies</span>
builder<span class="token punctuation">.</span><span class="token function">RegisterStateMachineSagas</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Saga1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Saga2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// registering saga state machines from current assembly</span>
builder<span class="token punctuation">.</span><span class="token function">RegisterStateMachineSagas</span><span class="token punctuation">(</span>Assembly<span class="token punctuation">.</span><span class="token function">GetExecutingAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// do not forget registering saga repositories</span>
<span class="token comment">// see examples below</span>
</code></pre></div><p>and load them from a contained when configuring the bus.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> busControl <span class="token operator">=</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span>busSettings<span class="token punctuation">.</span>HostAddress<span class="token punctuation">,</span> h <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        h<span class="token punctuation">.</span><span class="token function">Username</span><span class="token punctuation">(</span>busSettings<span class="token punctuation">.</span>Username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        h<span class="token punctuation">.</span><span class="token function">Password</span><span class="token punctuation">(</span>busSettings<span class="token punctuation">.</span>Password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span>busSettings<span class="token punctuation">.</span>QueueName<span class="token punctuation">,</span> ec <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// loading consumers</span>
        ec<span class="token punctuation">.</span><span class="token function">ConfigureConsumers</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// loading saga state machines</span>
        ec<span class="token punctuation">.</span><span class="token function">ConfigureSagas</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="saga-persistence"><a href="#saga-persistence" class="header-anchor">#</a> Saga persistence</h2> <p>Below you find samples of how to register different saga persistence implementations with Autofac.</p> <blockquote><p>Saga repositories must be registered as singletons (<code>SingleInstance()</code>).</p></blockquote> <h3 id="nhibernate"><a href="#nhibernate" class="header-anchor">#</a> NHibernate</h3> <p>For NHibernate you can scan an assembly where your saga instance mappings are defined to find the mapping classes, and then give the list of mapping types as a parameter to the session factory provider.</p> <p>Then, you instruct Autofac to use the session factory provider to get the <code>ISession</code> instance. NHibernate saga repository is then registered as generic and since it only uses the <code>ISession</code>, everything will just work.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> mappings <span class="token operator">=</span> mappingsAssembly
    <span class="token punctuation">.</span><span class="token function">GetTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>BaseType <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span>BaseType<span class="token punctuation">.</span>IsGenericType <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>t<span class="token punctuation">.</span>BaseType<span class="token punctuation">.</span><span class="token function">GetGenericTypeDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">SagaClassMapping<span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">||</span>
        t<span class="token punctuation">.</span>BaseType<span class="token punctuation">.</span><span class="token function">GetGenericTypeDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ClassMapping<span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlServerSessionFactoryProvider</span><span class="token punctuation">(</span>connString<span class="token punctuation">,</span> mappings<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ISessionFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">SingleInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">RegisterGeneric</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">NHibernateSagaRepository<span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">As</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ISagaRepository<span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="entity-framework"><a href="#entity-framework" class="header-anchor">#</a> Entity Framework</h3> <p>Entity Framework saga repository needs to have a context factory as a constructor parameter. This factory just returns a <code>DbContext</code> instance, which should have the information about the saga instance class mapping.</p> <p>You can register repository for your <code>SagaDbContext</code> like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">//Optimistic</span>
builder<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> EntityFrameworkSagaRepository<span class="token operator">&lt;</span>MySaga<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">CreateOptimistic</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">YourSagaDbContext</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ISagaRepository<span class="token punctuation">&lt;</span>MySaga<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SingleInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//Pessimistic</span>
builder<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> EntityFrameworkSagaRepository<span class="token operator">&lt;</span>MySaga<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">CreatePessimistic</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">YourSagaDbContext</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ISagaRepository<span class="token punctuation">&lt;</span>MySaga<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SingleInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>You can use your own context implementation and register the repository as generic like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>builder<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AssemblyScanningSagaDbContext</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">MySagaClassMap</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">,</span>
    connectionString<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">RegisterGeneric</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">EntityFrameworkSagaRepository<span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">As</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ISagaRepository<span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">SingleInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">RegisterStateMachineSagas</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">MySaga</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The example above uses the assembly scanning <code>DbContext</code> implementation, which you can find in <a href="https://gist.github.com/alexeyzimarev/34542645ff8f27550d0679c7cb696111" target="_blank" rel="noopener noreferrer">this gist<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="mongodb"><a href="#mongodb" class="header-anchor">#</a> MongoDB</h3> <p>Preferred way to use MongoDB saga repository is providing <code>IMongoDatabase</code> with <code>IMongoDbSagaConsumeContextFactory</code> and <code>ICollectionNameFormatter</code> as constructor parameters.</p> <p>You can register repository like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">//register default collection name formatter or you could use DotCaseCollectionNameFormatter (SimpleSaga -&gt; simple.sagas). Also you can create your own</span>
builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DefaultCollectionNameFormatter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  		 <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ICollectionNameFormatter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  		 <span class="token punctuation">.</span><span class="token function">SingleInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MongoDbSagaConsumeContextFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  		 <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMongoDbSagaConsumeContextFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  		 <span class="token punctuation">.</span><span class="token function">SingleInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
<span class="token class-name"><span class="token keyword">var</span></span> database <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MongoClient</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb://127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token string">&quot;sagas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MongoDbSagaRepository<span class="token punctuation">&lt;</span>MySaga<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
        database<span class="token punctuation">,</span>
        c<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMongoDbSagaConsumeContextFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        c<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ICollectionNameFormatter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">As</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ISagaRepository<span class="token punctuation">&lt;</span>MySaga<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">SingleInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MassTransit/MassTransit/edit/develop/docs/usage/containers/autofac.md" target="_blank" rel="noopener noreferrer">Help us by improving this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/26/2020, 1:18:48 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/usage/containers/multibus.html" class="prev">
        MultiBus
      </a></span> <span class="next"><a href="/usage/containers/castlewindsor.html">
        Castle Windsor
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.195ff7db.js" defer></script><script src="/assets/js/3.49f501da.js" defer></script><script src="/assets/js/108.6d56d230.js" defer></script>
  </body>
</html>
