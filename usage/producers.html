<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Producers | MassTransit</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#3a0839">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="description" content="A free, open-source distributed application framework for .NET.">
    <meta name="msapplication-TileColor" content="#3a0839">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.75c9abf4.css" as="style"><link rel="preload" href="/assets/js/app.195ff7db.js" as="script"><link rel="preload" href="/assets/js/3.49f501da.js" as="script"><link rel="preload" href="/assets/js/123.d34457fe.js" as="script"><link rel="prefetch" href="/assets/js/10.a0cd44ab.js"><link rel="prefetch" href="/assets/js/100.9feb174f.js"><link rel="prefetch" href="/assets/js/101.f3afae1f.js"><link rel="prefetch" href="/assets/js/102.edc3cfd3.js"><link rel="prefetch" href="/assets/js/103.396b5261.js"><link rel="prefetch" href="/assets/js/104.35ef931e.js"><link rel="prefetch" href="/assets/js/105.75295f36.js"><link rel="prefetch" href="/assets/js/106.c42d7948.js"><link rel="prefetch" href="/assets/js/107.4cddb7d4.js"><link rel="prefetch" href="/assets/js/108.6d56d230.js"><link rel="prefetch" href="/assets/js/109.3a2c9c0e.js"><link rel="prefetch" href="/assets/js/11.3d40bd0b.js"><link rel="prefetch" href="/assets/js/110.c4aa15ea.js"><link rel="prefetch" href="/assets/js/111.c661ab49.js"><link rel="prefetch" href="/assets/js/112.0f444d04.js"><link rel="prefetch" href="/assets/js/113.b7745232.js"><link rel="prefetch" href="/assets/js/114.1f4ecadb.js"><link rel="prefetch" href="/assets/js/115.6acc0049.js"><link rel="prefetch" href="/assets/js/116.59b4c1e7.js"><link rel="prefetch" href="/assets/js/117.0089265d.js"><link rel="prefetch" href="/assets/js/118.dee3db3a.js"><link rel="prefetch" href="/assets/js/119.c2dd72f1.js"><link rel="prefetch" href="/assets/js/12.67901ed9.js"><link rel="prefetch" href="/assets/js/120.2f521996.js"><link rel="prefetch" href="/assets/js/121.bf5544df.js"><link rel="prefetch" href="/assets/js/122.f63abbe1.js"><link rel="prefetch" href="/assets/js/124.39757413.js"><link rel="prefetch" href="/assets/js/125.5ae9566e.js"><link rel="prefetch" href="/assets/js/126.73bcf6ec.js"><link rel="prefetch" href="/assets/js/127.3d4534d5.js"><link rel="prefetch" href="/assets/js/128.c47aea17.js"><link rel="prefetch" href="/assets/js/129.e6499def.js"><link rel="prefetch" href="/assets/js/13.773b7e4f.js"><link rel="prefetch" href="/assets/js/130.30e02611.js"><link rel="prefetch" href="/assets/js/131.371a8da4.js"><link rel="prefetch" href="/assets/js/132.f5ff377c.js"><link rel="prefetch" href="/assets/js/133.edee58ae.js"><link rel="prefetch" href="/assets/js/134.40abac7e.js"><link rel="prefetch" href="/assets/js/135.7b10e613.js"><link rel="prefetch" href="/assets/js/136.6c4a4c9e.js"><link rel="prefetch" href="/assets/js/137.898fd9a1.js"><link rel="prefetch" href="/assets/js/138.c6591b9d.js"><link rel="prefetch" href="/assets/js/139.27a7976e.js"><link rel="prefetch" href="/assets/js/14.162fd7de.js"><link rel="prefetch" href="/assets/js/140.8f5fbf89.js"><link rel="prefetch" href="/assets/js/141.d2c4074e.js"><link rel="prefetch" href="/assets/js/142.ca465ae2.js"><link rel="prefetch" href="/assets/js/143.74deca00.js"><link rel="prefetch" href="/assets/js/144.70d74a91.js"><link rel="prefetch" href="/assets/js/145.6b2b56f8.js"><link rel="prefetch" href="/assets/js/146.f192058f.js"><link rel="prefetch" href="/assets/js/147.2dd1eca6.js"><link rel="prefetch" href="/assets/js/148.63cb766b.js"><link rel="prefetch" href="/assets/js/149.ecc8a933.js"><link rel="prefetch" href="/assets/js/15.5698f0da.js"><link rel="prefetch" href="/assets/js/150.4b4c3db8.js"><link rel="prefetch" href="/assets/js/16.5359a736.js"><link rel="prefetch" href="/assets/js/17.e09dee46.js"><link rel="prefetch" href="/assets/js/18.89fe105c.js"><link rel="prefetch" href="/assets/js/19.0ba8fb0f.js"><link rel="prefetch" href="/assets/js/20.a337dd2d.js"><link rel="prefetch" href="/assets/js/21.93618127.js"><link rel="prefetch" href="/assets/js/22.2956ed34.js"><link rel="prefetch" href="/assets/js/23.e7e073ac.js"><link rel="prefetch" href="/assets/js/24.6ae343c9.js"><link rel="prefetch" href="/assets/js/25.e5d4db2a.js"><link rel="prefetch" href="/assets/js/26.49ddf5e0.js"><link rel="prefetch" href="/assets/js/27.8ea45a54.js"><link rel="prefetch" href="/assets/js/28.ccb2b926.js"><link rel="prefetch" href="/assets/js/29.2433cbcd.js"><link rel="prefetch" href="/assets/js/30.b11f80e9.js"><link rel="prefetch" href="/assets/js/31.81256fb7.js"><link rel="prefetch" href="/assets/js/32.2ff0c303.js"><link rel="prefetch" href="/assets/js/33.4ce9ddd1.js"><link rel="prefetch" href="/assets/js/34.03bffcee.js"><link rel="prefetch" href="/assets/js/35.f8a9a551.js"><link rel="prefetch" href="/assets/js/36.8520137a.js"><link rel="prefetch" href="/assets/js/37.d9c6f0fa.js"><link rel="prefetch" href="/assets/js/38.92b36679.js"><link rel="prefetch" href="/assets/js/39.b958e128.js"><link rel="prefetch" href="/assets/js/4.c4d02356.js"><link rel="prefetch" href="/assets/js/40.29108793.js"><link rel="prefetch" href="/assets/js/41.a6366543.js"><link rel="prefetch" href="/assets/js/42.8b148511.js"><link rel="prefetch" href="/assets/js/43.e1763fb1.js"><link rel="prefetch" href="/assets/js/44.88d180c5.js"><link rel="prefetch" href="/assets/js/45.14b10a7d.js"><link rel="prefetch" href="/assets/js/46.93e3c7d7.js"><link rel="prefetch" href="/assets/js/47.e048c8cd.js"><link rel="prefetch" href="/assets/js/48.c5f9b4e8.js"><link rel="prefetch" href="/assets/js/49.70bccd74.js"><link rel="prefetch" href="/assets/js/5.4e88fd54.js"><link rel="prefetch" href="/assets/js/50.73312e50.js"><link rel="prefetch" href="/assets/js/51.e3a23273.js"><link rel="prefetch" href="/assets/js/52.ac5850db.js"><link rel="prefetch" href="/assets/js/53.964975e2.js"><link rel="prefetch" href="/assets/js/54.f8d8e32f.js"><link rel="prefetch" href="/assets/js/55.adab5810.js"><link rel="prefetch" href="/assets/js/56.aa0168c6.js"><link rel="prefetch" href="/assets/js/57.74697c72.js"><link rel="prefetch" href="/assets/js/58.0e7e958f.js"><link rel="prefetch" href="/assets/js/59.ee99df0c.js"><link rel="prefetch" href="/assets/js/6.b8b20bba.js"><link rel="prefetch" href="/assets/js/60.c20c903c.js"><link rel="prefetch" href="/assets/js/61.74ebb11f.js"><link rel="prefetch" href="/assets/js/62.5d7a7e72.js"><link rel="prefetch" href="/assets/js/63.c62b52d3.js"><link rel="prefetch" href="/assets/js/64.7c77fdd3.js"><link rel="prefetch" href="/assets/js/65.cb59ccfd.js"><link rel="prefetch" href="/assets/js/66.a7c3f8b7.js"><link rel="prefetch" href="/assets/js/67.95703483.js"><link rel="prefetch" href="/assets/js/68.6b4aef53.js"><link rel="prefetch" href="/assets/js/69.d94ed977.js"><link rel="prefetch" href="/assets/js/7.03c52a18.js"><link rel="prefetch" href="/assets/js/70.30b89105.js"><link rel="prefetch" href="/assets/js/71.7fb0a32a.js"><link rel="prefetch" href="/assets/js/72.04d95023.js"><link rel="prefetch" href="/assets/js/73.2ff7a268.js"><link rel="prefetch" href="/assets/js/74.d5c20b17.js"><link rel="prefetch" href="/assets/js/75.93bb57ce.js"><link rel="prefetch" href="/assets/js/76.55eb3fc8.js"><link rel="prefetch" href="/assets/js/77.5f66661c.js"><link rel="prefetch" href="/assets/js/78.14d0f57b.js"><link rel="prefetch" href="/assets/js/79.669c7d06.js"><link rel="prefetch" href="/assets/js/8.a356396f.js"><link rel="prefetch" href="/assets/js/80.efcf2688.js"><link rel="prefetch" href="/assets/js/81.d2e10130.js"><link rel="prefetch" href="/assets/js/82.b8ec9c21.js"><link rel="prefetch" href="/assets/js/83.9f22d6f2.js"><link rel="prefetch" href="/assets/js/84.4d1a6f69.js"><link rel="prefetch" href="/assets/js/85.d0dbb86b.js"><link rel="prefetch" href="/assets/js/86.3aa72ece.js"><link rel="prefetch" href="/assets/js/87.54f22267.js"><link rel="prefetch" href="/assets/js/88.85b21d95.js"><link rel="prefetch" href="/assets/js/89.2e8b9c83.js"><link rel="prefetch" href="/assets/js/9.ab3eeae2.js"><link rel="prefetch" href="/assets/js/90.61a4bb62.js"><link rel="prefetch" href="/assets/js/91.fef73b59.js"><link rel="prefetch" href="/assets/js/92.aec6eac0.js"><link rel="prefetch" href="/assets/js/93.caab4000.js"><link rel="prefetch" href="/assets/js/94.a156da91.js"><link rel="prefetch" href="/assets/js/95.a8412a27.js"><link rel="prefetch" href="/assets/js/96.d38de525.js"><link rel="prefetch" href="/assets/js/97.ede060e4.js"><link rel="prefetch" href="/assets/js/98.40ba68d7.js"><link rel="prefetch" href="/assets/js/99.fd9d661c.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.21f21cd2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.75c9abf4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/mt-logo-small.png" alt="MassTransit" class="logo"> <span class="site-name can-hide">MassTransit</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/discord.html" class="nav-link">
  Discord
</a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/getting-started/live-coding.html" class="sidebar-link">Live Coding</a></li><li><a href="/getting-started/upgrade-v6.html" class="sidebar-link">Upgrading</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/releases/" class="sidebar-heading clickable"><span>Release Notes</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/usage/" class="sidebar-heading clickable router-link-active open"><span>Using MassTransit</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/usage/configuration.html" class="sidebar-link">Configuration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/transports/" class="sidebar-heading clickable"><span>Transports</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/riders/" class="sidebar-heading clickable"><span>Riders</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/mediator.html" class="sidebar-link">Mediator</a></li><li><a href="/usage/messages.html" class="sidebar-link">Messages</a></li><li><a href="/usage/consumers.html" class="sidebar-link">Consumers</a></li><li><a href="/usage/producers.html" aria-current="page" class="active sidebar-link">Producers</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/usage/producers.html#send" class="sidebar-link">Send</a></li><li class="sidebar-sub-header"><a href="/usage/producers.html#publish" class="sidebar-link">Publish</a></li><li class="sidebar-sub-header"><a href="/usage/producers.html#message-initializers" class="sidebar-link">Message Initializers</a></li><li class="sidebar-sub-header"><a href="/usage/producers.html#send-headers" class="sidebar-link">Send Headers</a></li></ul></li><li><a href="/usage/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/usage/requests.html" class="sidebar-link">Requests</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/sagas/" class="sidebar-heading clickable"><span>Sagas</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/usage/containers/" class="sidebar-heading clickable"><span>Containers</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/usage/testing.html" class="sidebar-link">Testing</a></li><li><a href="/usage/logging.html" class="sidebar-link">Logging</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Advanced</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/learn/" class="sidebar-heading clickable"><span>Getting Help</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Articles</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/platform/" class="sidebar-heading clickable"><span>Platform</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="producers"><a href="#producers" class="header-anchor">#</a> Producers</h1> <p>An application or service can produce messages using two different methods. A message can be sent or a message can be published. The behavior of each method is very different, but it's easy to understand by looking at the type of messages involved with each particular method.</p> <p>When a message is sent, it is delivered to a specific endpoint using a <em>DestinationAddress</em>. When a message is published, it is not sent to a specific endpoint, but is instead broadcasted to any consumers which have <em>subscribed</em> to the message type. For these two separate behavior, we describe messages sent as commands, and messages published as events.</p> <blockquote><p>These are discussed in depth in the <a href="messages">Messages</a> section of the documentation.</p></blockquote> <h2 id="send"><a href="#send" class="header-anchor">#</a> Send</h2> <div class="custom-block tip"><p class="custom-block-title">Video</p> <p>Learn about <code>Send</code> in <a href="https://youtu.be/t6FsmqZsdJk" target="_blank" rel="noopener noreferrer">this short video<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <p>To send a message, the <em>DestinationAddress</em> is used to deliver the message to an endpoint — such as a queue. One of the <code>Send</code> method overloads on the <code>ISendEndpoint</code> interface is called, which will then send the message to the transport. An <code>ISendEndpoint</code> is obtained from one of the following objects:</p> <ol><li><p>The <code>ConsumeContext</code> of the message being consumed</p> <p>This ensures that the correlation headers, message headers, and trace information is propagated to the sent message.</p></li> <li><p>An <code>ISendEndpointProvider</code> instance</p> <p>This may be passed as an argument, but is typically specified on the constructor of an object that is resolved using a dependency injection container.</p></li> <li><p>The <code>IBus</code></p> <p>The last resort, and should only be used for messages that are being sent by an <em>initiator</em> — a process that is initiating a business process.</p></li></ol> <p>Once the <code>Send</code> method has been called (only once or repeatedly to send a series of messages), the <code>ISendEndpoint</code> reference should fall out of scope.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Applications should not store the <code>ISendEndpoint</code> reference, it is automatically cached by MassTransit and discarded when it is no longer needed.</p></div> <p>For instance, an <code>IBus</code> instance is a send endpoint provider, but it should <em>never</em> be used by a consumer to obtain an <code>ISendEndpoint</code>. <code>ConsumeContext</code> can also provide send endpoints, and should be used since it is <em>closer</em> to the consumer.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>This cannot be stressed enough -- always obtain an <code>ISendEndpoint</code> from the closest scope. There is extensive logic to tie message flows together using conversation, correlation, and initiator identifiers. By skipping a level and going outside the closest scope, that critical information will be lost which prevents the useful trace identifiers from being propagated.</p></div> <h3 id="send-endpoint"><a href="#send-endpoint" class="header-anchor">#</a> Send Endpoint</h3> <p>To obtain a send endpoint from a send endpoint provider, call the <code>GetSendEndpoint</code> method as shown below. The method is <em>async</em>, so be sure to <em>await</em> the result.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubmitOrder</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SendOrder</span><span class="token punctuation">(</span><span class="token class-name">ISendEndpointProvider</span> sendEndpointProvider<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> endpoint <span class="token operator">=</span> <span class="token keyword">await</span> sendEndpointProvider<span class="token punctuation">.</span><span class="token function">GetSendEndpoint</span><span class="token punctuation">(</span>_serviceAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> endpoint<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SubmitOrder</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> <span class="token string">&quot;123&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>There are many overloads for the <code>Send</code> method. Because MassTransit is built around filters and pipes, pipes are used to customize the message delivery behavior of Send. There are also some useful overloads (via extension methods) to make sending easier and less noisy due to the pipe construction, etc.</p> <h3 id="endpoint-address"><a href="#endpoint-address" class="header-anchor">#</a> Endpoint Address</h3> <p>An endpoint address is a fully-qualified URI which may include transport-specific details. For example, an endpoint on a local RabbitMQ server would be:</p> <div class="language- extra-class"><pre class="language-text"><code>rabbitmq://localhost/input-queue
</code></pre></div><p>Transport-specific details may include query parameters, such as:</p> <div class="language- extra-class"><pre class="language-text"><code>rabbitmq://localhost/input-queue?durable=false
</code></pre></div><p>This would configure the queue as non-durable, where messages would only be stored in memory and therefore would not survive a broker restart.</p> <h4 id="short-addresses"><a href="#short-addresses" class="header-anchor">#</a> Short Addresses</h4> <p>Starting with MassTransit v6, short addresses are supported. For instance, to obtain a send endpoint for a queue on RabbitMQ, the caller would only have to specify:</p> <div class="language- extra-class"><pre class="language-text"><code>GetSendEndpoint(new Uri(&quot;queue:input-queue&quot;))
</code></pre></div><p>This would return a send endpoint for the <em>input-queue</em> exchange, which would be bound to the <em>input-queue</em> queue. Both the exchange and the queue would be created if either did not exist. This short syntax eliminates the need to know the scheme, host, port, and virtual host of the broker, only the queue and/or exchange details are required.</p> <p>Each transport has a specific set of supported short addresses.</p> <h5 id="supported-address-schemes"><a href="#supported-address-schemes" class="header-anchor">#</a> Supported Address Schemes</h5> <table><thead><tr><th>Short Address</th> <th style="text-align:center;">RabbitMQ</th> <th style="text-align:center;">Azure Service Bus</th> <th style="text-align:center;">ActiveMQ</th> <th style="text-align:center;">Amazon SQS</th></tr></thead> <tbody><tr><td>queue:name</td> <td style="text-align:center;">✔️</td> <td style="text-align:center;">✔️</td> <td style="text-align:center;">✔️</td> <td style="text-align:center;">✔️</td></tr> <tr><td>topic:name</td> <td style="text-align:center;"></td> <td style="text-align:center;">✔️</td> <td style="text-align:center;">✔️</td> <td style="text-align:center;">✔️</td></tr> <tr><td>exchange:name</td> <td style="text-align:center;">✔️</td> <td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:center;"></td></tr></tbody></table> <h3 id="address-conventions"><a href="#address-conventions" class="header-anchor">#</a> Address Conventions</h3> <p>Using send endpoints might seem too verbose, because before sending any message, you need to get the send endpoint and to do that you need to have an endpoint address. Usually, addresses are kept in the configuration and accessing the configuration from all over the application is not a good practice.</p> <p>Endpoint conventions solve this issue by allowing you to configure the mapping between message types and endpoint addresses. A potential downside here that you will not be able to send messages of the same type to different endpoints by using conventions. If you need to do this, keep using the <code>GetSendEndpoint</code> method.</p> <p>Conventions are configured like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>EndpointConvention<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Map</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">&quot;rabbitmq://mq.acme.com/order/order_processing&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now, you don't need to get the send endpoint anymore for this type of message and can send it like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Post</span><span class="token punctuation">(</span><span class="token class-name">SubmitOrderRequest</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">AllGoodWith</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token function">ConvertToCommand</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Also, from inside the consumer, you can do the same using the <code>ConsumeContext.Send</code> overload:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>EndpointConvention<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Map</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>StartDelivery<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span>ConfigurationManager<span class="token punctuation">.</span>AppSettings<span class="token punctuation">[</span><span class="token string">&quot;deliveryServiceQueue&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubmitOrderConsumer</span> <span class="token punctuation">:</span> 
    <span class="token type-list"><span class="token class-name">IConsumer<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IOrderSubmitter</span> _orderSubmitter<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SubmitOrderConsumer</span><span class="token punctuation">(</span><span class="token class-name">IOrderSubmitter</span> submitter<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> _orderSubmitter <span class="token operator">=</span> submitter<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Consume</span><span class="token punctuation">(</span><span class="token class-name">IConsumeContext<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _orderSubmitter<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">StartDelivery</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>EndpointConvention.Map&lt;T&gt;</code> method is static, so it can be called from everywhere. It is important to remember that you cannot configure conventions for the same message twice. If you try to do this - the <code>Map</code> method will throw an exception. This is also important when writing tests, so you need to configure the conventions at the same time as you configure your test bus (harness).</p> <p>It is better to configure send conventions before you start the bus.</p> <h2 id="publish"><a href="#publish" class="header-anchor">#</a> Publish</h2> <div class="custom-block tip"><p class="custom-block-title">Video</p> <p>Learn about <code>Publish</code> in <a href="https://youtu.be/-MAEZq5G7lk" target="_blank" rel="noopener noreferrer">this short video<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <p>Messages are published similarly to how messages are sent, but in this case, a single <code>IPublishEndpoint</code> is used. The same rules for endpoints apply, the closest instance of the publish endpoint should be used. So the <code>ConsumeContext</code> for consumers, and <code>IBus</code> for applications that are published outside of a consumer context.</p> <div class="custom-block tip"><p class="custom-block-title">Key Concept</p> <p>In MassTransit, <em>Publish</em> follows the <a href="http://www.enterpriseintegrationpatterns.com/patterns/messaging/PublishSubscribeChannel.html" target="_blank" rel="noopener noreferrer">publish subscribe<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> messaging pattern. For each message published, a copy of the message is delivered to each subscriber. The mechanism by which this happens is implemented by the message transport, but semantically the operation is the same regardless of which transport is used.</p></div> <p>The same guidelines apply for publishing messages, the closest object should be used.</p> <ol><li><p>The <code>ConsumeContext</code> of the message being consumed</p> <p>This ensures that the correlation headers, message headers, and trace information is propagated to the published message.</p></li> <li><p>An <code>IPublishEndpoint</code> instance</p> <p>This may be passed as an argument, but is typically specified on the constructor of an object that is resolved using a dependency injection container.</p></li> <li><p>The <code>IBus</code></p> <p>The last resort, and should only be used for messages that are being published by an <em>initiator</em> — a process that is initiating a business process.</p></li></ol> <p>To publish a message, see the code below:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderSubmitted</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">DateTime</span> OrderDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">NotifyOrderSubmitted</span><span class="token punctuation">(</span><span class="token class-name">IPublishEndpoint</span> publishEndpoint<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">await</span> publishEndpoint<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Publish</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderSubmitted<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span>
    <span class="token punctuation">{</span>
        OrderId <span class="token operator">=</span> <span class="token string">&quot;27&quot;</span><span class="token punctuation">,</span>
        OrderDate <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If you are planning to publish messages from within your consumers, this example would suit better:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubmitOrderConsumer</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IConsumer<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IOrderSubmitter</span> _orderSubmitter<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SubmitOrderConsumer</span><span class="token punctuation">(</span><span class="token class-name">IOrderSubmitter</span> submitter<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> _orderSubmitter <span class="token operator">=</span> submitter<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Consume</span><span class="token punctuation">(</span><span class="token class-name">IConsumeContext<span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _orderSubmitter<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Publish</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderSubmitted<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span>
        <span class="token punctuation">{</span>
            OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">,</span>
            OrderDate <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="sending-via-interfaces"><a href="#sending-via-interfaces" class="header-anchor">#</a> Sending via interfaces</h3> <p>Since the general recommendation is to use interfaces, there are convenience methods to initialize the interface without requiring the creation of a message class underneath. While versioning of messages still requires a class which supports multiple interfaces, a simple approach to send an interface message is shown below.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubmitOrder</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">DateTime</span> OrderDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">decimal</span></span> OrderAmount <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SendOrder</span><span class="token punctuation">(</span><span class="token class-name">ISendEndpoint</span> endpoint<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">await</span> endpoint<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Send</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span>
    <span class="token punctuation">{</span>
        OrderId <span class="token operator">=</span> <span class="token string">&quot;27&quot;</span><span class="token punctuation">,</span>
        OrderDate <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
        OrderAmount <span class="token operator">=</span> <span class="token number">123.45m</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="message-initializers"><a href="#message-initializers" class="header-anchor">#</a> Message Initializers</h2> <p>MassTransit continues to encourage and support the use of interfaces for message contracts, and initializers make it easy to produce interface messages.</p> <h3 id="anonymous-object-values"><a href="#anonymous-object-values" class="header-anchor">#</a> Anonymous object values</h3> <p><code>Send</code>, <code>Publish</code>, and most of the methods that behave in similar ways (scheduling, responding to requests, etc.) all support passing an object of <em>values</em> which is used to set the properties on the specified interface. A simple example is shown below.</p> <p>Consider this example message contract to submit an order.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubmitOrder</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">DateTime</span> OrderDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> OrderNumber <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">decimal</span></span> OrderAmount <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>To send this message to an endpoint:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">await</span> endpoint<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Send</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span>
<span class="token punctuation">{</span>
    OrderId <span class="token operator">=</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    OrderDate <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
    OrderNumber <span class="token operator">=</span> <span class="token string">&quot;18001&quot;</span><span class="token punctuation">,</span>
    OrderAmount <span class="token operator">=</span> <span class="token number">123.45m</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The anonymous object is loosely typed, the properties are matched by name, and there is an extensive set of type conversions that may occur to obtain match the types defined by the interface. Most numeric, string, and date/time conversions are supported, as well as several advanced conversions (including variables, and asynchronous <code>Task&lt;T&gt;</code> results).</p> <p>Collections, including arrays, lists, and dictionaries, are broadly supported, including the conversion of list elements, as well as dictionary keys and values. For instance, a dictionary of (int,decimal) could be converted on the fly to (long, string) using the default format conversions.</p> <p>Nested objects are also supported, for instance, if a property was of type <code>Address</code> and another anonymous object was created (or any type whose property names match the names of the properties on the message contract), those properties would be set on the message contract.</p> <h3 id="headers"><a href="#headers" class="header-anchor">#</a> Headers</h3> <p>Header values can be specified in the anonymous object using a double-underscore (pronounced 'dunder' apparently) property name. For instance, to set the message time-to-live, specify a property with the duration. Remember, any value that can be converted to a <code>TimeSpan</code> works!</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GetOrderStatus</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> requestClient<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetResponse</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatus<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> 
<span class="token punctuation">{</span>
    __TimeToLive <span class="token operator">=</span> <span class="token number">15000</span><span class="token punctuation">,</span> <span class="token comment">// 15 seconds, or in this case, 15000 milliseconds</span>
    OrderId <span class="token operator">=</span> orderId<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>actually, that's a bad example since the request client already sets the message expiration, but you, get, the, point.</p></blockquote> <p>To add a custom header value, a special property name format is used. In the name, underscores are converted to dashes, and double underscores are converted to underscores. In the following example:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> requestClient<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetResponse</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderStatus<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> 
<span class="token punctuation">{</span>
    __Header_X_B3_TraceId <span class="token operator">=</span> zipkinTraceId<span class="token punctuation">,</span>
    __Header_X_B3_SpanId <span class="token operator">=</span> zipkinSpanId<span class="token punctuation">,</span>
    OrderId <span class="token operator">=</span> orderId<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This would include set the headers used by open tracing (or Zipkin, as shown above) as part of the request message so the service could share in the span/trace. In this case, <code>X-B3-TraceId</code> and <code>X-B3-SpanId</code> would be added to the message envelope, and depending upon the transport, copied to the transport headers as well.</p> <h3 id="variables"><a href="#variables" class="header-anchor">#</a> Variables</h3> <p>MassTransit also supports variables, which are special types added to the anonymous object. Following the example above, the initialization could be changed to use variables for the <code>OrderId</code> and <code>OrderDate</code>. Variables are consistent throughout the message creation, using the same variable multiple times returns the value. For instance, the Id created to set the <em>OrderId</em> would be the same used to set the <em>OrderId</em> in each item.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderItem</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> ItemNumber <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubmitOrder</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">DateTime</span> OrderDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> OrderNumber <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">decimal</span></span> OrderAmount <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">OrderItem<span class="token punctuation">[</span><span class="token punctuation">]</span></span> OrderItems <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">await</span> endpoint<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Send</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span>
<span class="token punctuation">{</span>
    OrderId <span class="token operator">=</span> InVar<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
    OrderDate <span class="token operator">=</span> InVar<span class="token punctuation">.</span>Timestamp<span class="token punctuation">,</span>
    OrderNumber <span class="token operator">=</span> <span class="token string">&quot;18001&quot;</span><span class="token punctuation">,</span>
    OrderAmount <span class="token operator">=</span> <span class="token number">123.45m</span><span class="token punctuation">,</span>
    OrderItems <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> InVar<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> ItemNumber <span class="token operator">=</span> <span class="token string">&quot;237&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> InVar<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> ItemNumber <span class="token operator">=</span> <span class="token string">&quot;762&quot;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="awaiting-task-results"><a href="#awaiting-task-results" class="header-anchor">#</a> Awaiting Task results</h3> <p>Message initializers are now asynchronous, which makes it possible to do some pretty cool things, including waiting for Task input properties to complete and use the result to initialize the property. An example is shown below.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderUpdated</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">DateTime</span> Timestamp <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">Customer</span> Customer <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>CustomerInfo<span class="token punctuation">&gt;</span></span> <span class="token function">LoadCustomer</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> orderId<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// work happens up in here</span>
<span class="token punctuation">}</span>

<span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Publish</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OrderUpdated<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span>
<span class="token punctuation">{</span>
    InVar<span class="token punctuation">.</span>CorrelationId<span class="token punctuation">,</span>
    InVar<span class="token punctuation">.</span>Timestamp<span class="token punctuation">,</span>
    OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">,</span>
    Customer <span class="token operator">=</span> <span class="token function">LoadCustomer</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The property initializer will wait for the task result and then use it to initialize the property (converting all the types, etc. as it would any other object).</p> <blockquote><p>While it is of course possible to await the call to <code>LoadCustomer</code>, properties are initialized in parallel, and thus, allowing the initializer to await the Task can result in better overall performance. Your mileage may vary, however.</p></blockquote> <h2 id="send-headers"><a href="#send-headers" class="header-anchor">#</a> Send Headers</h2> <p>There are a variety of message headers available which are used for correlation and tracking of messages. It is also possible to override some of the default behaviors of MassTransit when a fault occurs. For instance, a fault is normally <em>published</em> when a consumer throws an exception. If instead the application wants faults delivered to a specific address, the <code>FaultAddress</code> can be specified via a header. How this is done is shown below.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubmitOrder</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name">DateTime</span> OrderDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token return-type class-name"><span class="token keyword">decimal</span></span> OrderAmount <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SendOrder</span><span class="token punctuation">(</span><span class="token class-name">ISendEndpoint</span> endpoint<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">await</span> endpoint<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Send</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span>
    <span class="token punctuation">{</span>
        OrderId <span class="token operator">=</span> <span class="token string">&quot;27&quot;</span><span class="token punctuation">,</span>
        OrderDate <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
        OrderAmount <span class="token operator">=</span> <span class="token number">123.45m</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>FaultAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">&quot;rabbitmq://localhost/order_faults&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Since a message initializer is being used, this can actually be simplified.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SendOrder</span><span class="token punctuation">(</span><span class="token class-name">ISendEndpoint</span> endpoint<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">await</span> endpoint<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Send</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SubmitOrder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span>
    <span class="token punctuation">{</span>
        OrderId <span class="token operator">=</span> <span class="token string">&quot;27&quot;</span><span class="token punctuation">,</span>
        OrderDate <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
        OrderAmount <span class="token operator">=</span> <span class="token number">123.45m</span><span class="token punctuation">,</span>

        <span class="token comment">// header names are prefixed with __, and types are converted as needed</span>
        __FaultAddress <span class="token operator">=</span> <span class="token string">&quot;rabbitmq://localhost/order_faults&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MassTransit/MassTransit/edit/develop/docs/usage/producers.md" target="_blank" rel="noopener noreferrer">Help us by improving this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/28/2021, 2:41:00 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/usage/consumers.html" class="prev">
        Consumers
      </a></span> <span class="next"><a href="/usage/exceptions.html">
        Exceptions
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.195ff7db.js" defer></script><script src="/assets/js/3.49f501da.js" defer></script><script src="/assets/js/123.d34457fe.js" defer></script>
  </body>
</html>
